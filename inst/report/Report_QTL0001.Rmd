---
output:
  html_document:
    mathjax: null
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
    css: styles.css
params:
  dfResults: NA
  dfGroups: NA
  dfListing: NA
---

```{r setup, include=FALSE} 
library(dplyr)
library(gsm.kri)
library(gsm.qtl)
library(reactable)

knitr::opts_chunk$set(warning = FALSE, message = FALSE) 

dfResultsStudy <- params$dfResults %>% filter(GroupLevel == "Study")
dfResultsSite <- params$dfResults %>% filter(GroupLevel == "Site")
dfGroups <- params$dfGroups
dfListing <- params$dfListing

length_snapshots = dfResultsSite$SnapshotDate %>% n_distinct()
latest_snapshot = unique(dfResultsSite$SnapshotDate)[length_snapshots]
```

---
title: "QTL Overview"
subtitle: "Study: `r unique(dfListing$studyid)`"
date: "Snapshot Date: `r latest_snapshot`"
--- 

## Study Overview
```{r, echo=FALSE, results='asis'}
dfResultsStudy %>%
  filter(GroupLevel == "Study",
         SnapshotDate == latest_snapshot,
         GroupID != "Upper_funnel") %>%
  mutate(Ineligible_Rate = paste0(as.character(Metric*100),"%"),
         Deviation = ifelse(Metric > upper_funnel, "Yes", "No"),
         upper_funnel = paste0(as.character(round(upper_funnel,3)*100), "%")) %>%
  mutate_all(as.character) %>%
  select(GroupID, Numerator, Denominator, Ineligible_Rate, upper_funnel, Deviation) %>%
  tidyr::pivot_longer(., cols = c(GroupID, Numerator, Denominator, Ineligible_Rate, upper_funnel, Deviation), names_to = "Param", values_to = "Value") %>%
  mutate(Param = case_when(
    Param == "GroupID" ~ "StudyID",
    Param == "Numerator" ~ "Eligibility Not Met",
    Param == "Denominator" ~ "Total Enrolled",
    Param == "Ineligible_Rate" ~ "Current Ineligible Enrolled Rate",
    Param == "upper_funnel" ~ "Current Threshold",
    Param == "Deviation" ~ "Deviation?"
  )) %>% 
  reactable()
```

## Results
```{r, echo=FALSE, results='asis'}

#establish how many snapshots there were and find latest one for barchart

qtl_timeseries_study <- gsm.qtl::Widget_TimeSeriesQTL(
  dfResults = dfResultsStudy,
  dfGroups = dfGroups,
  strOutcome = "Metric"
)

qtl_barchart_site <- gsm.qtl::Widget_BarChartQTL(
  dfResults = dfResultsSite %>% filter(SnapshotDate == latest_snapshot),
  dfGroups = dfGroups,
  strOutcome = "Metric"
)
lCharts <- list(
  timeSeries = qtl_timeseries_study,
  barChart = qtl_barchart_site
)
gsm.kri::Report_MetricCharts(lCharts)
```

## Inclusion/Exclusion Listing
```{r, echo = FALSE, results='asis'}
reactable::reactable(dfListing, searchable = TRUE)
```

```{r echo=FALSE}
group_dropdown <- system.file('report', 'lib', 'overallGroupDropdown.js', package = "gsm.kri")
dropdown_drag <- system.file('report', 'lib', 'dragOverallGroupDropdown.js', package = "gsm.kri")
toggle_toc <- system.file('report', 'lib', 'toggleTOC.js', package = "gsm.kri")
```

```{js, file={group_dropdown}, echo=FALSE }
```

```{js, file={dropdown_drag}, echo=FALSE}
```

```{js, file={toggle_toc}, echo=FALSE}
```
