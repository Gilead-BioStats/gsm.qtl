---
output:
  html_document:
    mathjax: null
params:
  dfResults: NA
  dfGroups: NA
  dfListing: NA
---



```{r setup, include=FALSE} 
library(dplyr)
library(gsm.kri)
library(gsm.qtl)
library(ggplot2)
library(plotly)
library(gt)
library(htmltools)

knitr::opts_chunk$set(warning = FALSE, message = FALSE)

dfResults <- params$dfResults
dfGroups <- params$dfGroups
dfListing <- params$dfListing

length_snapshots = dfResults$SnapshotDate %>% n_distinct()
latest_snapshot = unique(dfResults$SnapshotDate)[length_snapshots]
```



---
title: "QTL Overview"
subtitle: "Study: `r unique(dfListing$studyid)`"
date: "Snapshot Date: `r latest_snapshot`"
---

## Study Overview
```{r, echo=FALSE, results='asis'}
QTL_Overview(dfResults = dfResults,
             strQTLid = "Analysis_qtl0001_study",
             dSnapshot = latest_snapshot,
             strNum = "Ineligible Participants",
             strDenom = "Total Enrolled", 
             strQTL = "Current Ineligible Enrolled Rate")
```

# Results

## Time Series Chart
```{r, echo=FALSE, results='asis', fig.height=4}
# gsm.qtl::Widget_TimeSeriesQTL(
#   dfResults = dfResults %>% filter(GroupLevel == "Study"),
#   dfGroups = dfGroups,
#   strOutcome = "Metric"
# )
# Create reference table for funnel bounds per date
QTL_lineplot(dfResults = dfResults, strQTLid = "Analysis_qtl0001_study",strQTL = "Ineligibility Rate")
```

## Bar Charts {.tabset .tabset-pills}

```{r, eval = FALSE , echo = FALSE, results = 'asis', fig.height=4}
### JS - Site
# gsm.qtl::Widget_BarChartQTL(
#   dfResults = dfResults %>% filter(GroupLevel == "Site", SnapshotDate == latest_snapshot, GroupID != "Upper_funnel"),
#   dfGroups = dfGroups,
#   strOutcome = "Metric"
# )
```

### Site
```{r, echo = FALSE, results = 'asis', fig.height=4}
eligibility_groupBar(df = dfListing, varGroupID = invid, strGroupLabel = "Site")
```

### Country
```{r, echo = FALSE, results = 'asis', fig.height=4}
eligibility_groupBar(df = dfListing, varGroupID = country, strGroupLabel = "Country")
```

### Source
```{r, echo = FALSE, results = 'asis', fig.height=4}
eligibility_sourceBar(df = dfListing)
```



### Criteria/Site
```{r, echo = FALSE, results = 'asis', fig.height=4}
site_criteria_bar <- dfListing %>% 
  filter(!is.na(ietestcd_concat) | Source == "Eligibility IPD") %>% 
  mutate(
    ietestcd_concat = case_when(
      is.na(ietestcd_concat) ~ "Eligibility IPD",
      stringr::str_detect(ietestcd_concat, ";;;") ~ "Multiple",
      TRUE ~ ietestcd_concat
    )
  ) %>%  
  ggplot(., aes(x = ietestcd_concat, fill = invid)) +
  geom_bar() +
  labs(x = "Criteria", y = "Criteria Count", fill = "Site", title = "Eligibility by site", caption = "Footnote: Partipants can be ineligible for multiple criteria.") + 
  theme_classic(base_size = 11) + 
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),  # tilt to avoid overlap
    panel.grid.major.x = element_blank()
  ) 
plotly::ggplotly(site_criteria_bar)
```



### Criteria/Country
```{r, echo = FALSE, results = 'asis', fig.height=4}
country_criteria_bar <- dfListing %>% 
  filter(!is.na(ietestcd_concat) | Source == "Eligibility IPD") %>% 
  mutate(
    ietestcd_concat = case_when(
      is.na(ietestcd_concat) ~ "Eligibility IPD",
      stringr::str_detect(ietestcd_concat, ";;;") ~ "Multiple",
      TRUE ~ ietestcd_concat
    )
  ) %>% 
  ggplot(., aes(x = ietestcd_concat, fill = country)) +
  geom_bar() +
  labs(x = "Criteria", y = "Criteria Count", fill = "Country", title = "Eligibility by Country", caption = "Footnote: Partipants can be ineligible for multiple criteria.") + 
  theme_classic(base_size = 11) + 
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),  # tilt to avoid overlap
    panel.grid.major.x = element_blank()
  ) 
plotly::ggplotly(country_criteria_bar)
```



## Inclusion/Exclusion Listing
```{r, echo = FALSE, results='asis'}
scrollable_gt <- function(gt_tbl, height = "300px", min_table_width = "1200px") {
  div(
    style = sprintf("
      max-height: %s;
      overflow-y: auto;
      overflow-x: auto;
      border: 1px solid #ccc;
    ", height),
    div(
      style = sprintf("min-width: %s;", min_table_width),
      gt_tbl
    )
  )
}

dfListing %>% 
  filter(Source != "Neither") %>% 
  select(invid, country, subjid, Source, ietestcd_concat, dvdtm, eligibility_criteria) %>% 
  # tidyr::separate(
  #   ietestcd_concat, 
  #   into = paste0("", seq_len(max(sapply(strsplit(dfListing$ietestcd_concat, ";;;"), length)))),
  #   sep = ";;;",
  #   fill = "right"
  # ) %>%
  tidyr::separate(
    dvdtm, 
    into = paste0("PD Date", seq_len(max(sapply(strsplit(dfListing$dvdtm, ";;;"), length)))),
    sep = ";;;",
    fill = "right"
  ) %>% 
  mutate_at(vars(starts_with("PD Date")) , ~substr(.x, 1, 10)) %>% 
  tidyr::separate(
    eligibility_criteria, 
    into = paste0("PD Term", seq_len(max(sapply(strsplit(dfListing$eligibility_criteria, ";;;"), length)))),
    sep = ";;;",
    fill = "right"
  ) %>% 
  rename(
    Site = invid,
    Country = country,
    `Subject ID` = subjid,
    `Which I/E` = ietestcd_concat
  ) %>% 
  gt::gt() %>%
  text_transform(
    locations = cells_body(columns = c(`Which I/E`, starts_with("PD Term"))),
    fn = function(x) {
      vapply(x, function(txt) {
        if (is.na(txt) || !nzchar(txt)) return("")

        # Tooltip: escape to be safe
        tooltip <- htmlEscape(txt)

        # Visual truncation logic based on plain text
        plain <- gsub("<[^>]+>", "", txt)
        should_truncate <- nchar(plain) > 10

        display_html <- if (should_truncate) {
          # You could optionally also truncate the HTML, but that's tricky.
          txt  # just use full HTML; visual cutoff will be via CSS
        } else {
          txt
        }

        html(
          sprintf(
            '<div title="%s" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100px;">%s</div>',
            tooltip, display_html
          )
        )
      }, FUN.VALUE = html(""))
    }
  ) %>% 
  # opt_interactive(use_search = TRUE,
  #                 use_filters = TRUE,
  #                 page_size_default = 25) %>% 
  scrollable_gt(., height = "500px")
```
