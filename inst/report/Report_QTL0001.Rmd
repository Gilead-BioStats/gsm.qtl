---
output:
  html_document:
    mathjax: null
params:
  dfResults: NA
  dfGroups: NA
  dfListing: NA
---



```{r setup, include=FALSE} 
library(dplyr)
library(gsm.kri)
library(gsm.qtl)
library(ggplot2)
library(plotly)
library(gt)
library(htmltools)

knitr::opts_chunk$set(warning = FALSE, message = FALSE)

dfResults <- params$dfResults
dfGroups <- params$dfGroups
dfListing <- params$dfListing

length_snapshots = dfResults$SnapshotDate %>% n_distinct()
latest_snapshot = unique(dfResults$SnapshotDate)[length_snapshots]
```



---
title: "QTL Overview"
subtitle: "Study: `r unique(dfListing$studyid)`"
date: "Snapshot Date: `r latest_snapshot`"
---



## Study Overview
```{r, echo=FALSE, results='asis'}
QTL_Overview(dfResults = dfResults,
             strQTLid = "Analysis_qtl0001_study",
             dSnapshot = latest_snapshot,
             strNum = "Ineligible Participants",
             strDenom = "Total Enrolled", 
             strQTL = "Current Ineligible Enrolled Rate")
```



# Results



## Time Series Chart
```{r, echo=FALSE, results='asis', fig.height=4}
# gsm.qtl::Widget_TimeSeriesQTL(
#   dfResults = dfResults %>% filter(GroupLevel == "Study"),
#   dfGroups = dfGroups,
#   strOutcome = "Metric"
# )
# Create reference table for funnel bounds per date
df_plot <- dfResults %>%
  filter(GroupLevel == "Study") %>%
  select(GroupID, Numerator, Denominator, Metric, SnapshotDate) %>%
  mutate(SnapshotDate = as.Date(SnapshotDate)) %>%
  # Add group type
  mutate(group_type = case_when(
    GroupID == "Upper_funnel" ~ "QTL Threshold",
    GroupID == "Flatline" ~ "Nominal Threshold",
    TRUE ~ "Ineligibility Rate"
  ))



# Pivot thresholds to wide format
thresholds <- df_plot %>%
  filter(GroupID %in% c("Upper_funnel", "Flatline")) %>%
  select(SnapshotDate, GroupID, Metric) %>%
  tidyr::pivot_wider(names_from = GroupID, values_from = Metric)



# Join thresholds to full data
df_joined <- df_plot %>%
  left_join(thresholds, by = "SnapshotDate") %>%
  mutate(
    # Point color logic for main group only
    point_color = case_when(
      group_type != "Ineligibility Rate" ~ NA_character_,
      Metric > `Upper_funnel` ~ "red",
      TRUE ~ "green"
    ),
    tooltip_text = case_when(
      group_type != "Ineligibility Rate" ~ paste0(
        group_type, "
",
        "Date: ", SnapshotDate, "
",
        "Metric: ", round(Metric, 3)
      ),
      TRUE ~ paste0(
        "Study: ", GroupID, "
",
        "Date: ", SnapshotDate, "
",
        "Metric: ", round(Metric, 3), "
",
        "Numerator: ", Numerator, "
",
        "Denominator: ", Denominator
      )
    )
  )



# Build ggplot
p <- ggplot(
  df_joined,
  aes(x = SnapshotDate, y = Metric, group = GroupID, text = tooltip_text)
) +
  # Line with custom linetype
  geom_line(
    data = df_joined %>%
      filter(group_type %in% c("Ineligibility Rate", "QTL Threshold", "Nominal Threshold")),
    aes(color = group_type, linetype = group_type, linewidth = group_type),
    size = 1,
    show.legend = FALSE
  ) +
  
  # Colored points for Ineligibility Rate (keep color, hide legend)
  geom_point(
    data = df_joined %>% filter(group_type == "Ineligibility Rate"),
    aes(color = point_color),
    size = 2,
    show.legend = FALSE
  ) +
  
  # Points for thresholds (hide legend)
  geom_point(
    data = df_joined %>% filter(group_type != "Ineligibility Rate"),
    aes(color = group_type),
    size = 1,
    show.legend = FALSE
  ) +
  
  # Combine all colors in scale but only show legend for line groups
  scale_color_manual(
    values = c(
      "QTL Threshold" = "#FF5859",
      "Nominal Threshold" = "grey80",
      "Ineligibility Rate" = "grey50",
      "red" = "#FF5859",
      "green" = "#3DAF06"
    ),
    breaks = c("Ineligibility Rate", "Nominal Threshold", "QTL Threshold"),
    name = NULL
  ) +
  scale_linetype_manual(
    values = c(
      "QTL Threshold" = "dashed",
      "Nominal Threshold" = "dotted",
      "Ineligibility Rate" = "solid"
    )
  ) +
  scale_linewidth_manual(
    values = c(
      "QTL Threshold" = 0.75,
      "Nominal Threshold" = 0.5,
      "Ineligibility Rate" = 0.75
    )
  ) +
  
  # scale_x_date(date_labels = "%Y-%m-%d", date_breaks = "1 month") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 30),
    legend.position = "none"
  ) +
  labs(
    y = "Ineligibility",
    x = "Snapshot Date"
  )





ggplotly(p, tooltip = "text")
```


## Bar Charts {.tabset .tabset-pills}



```{r, eval = FALSE , echo = FALSE, results = 'asis', fig.height=4}
### JS - Site
# gsm.qtl::Widget_BarChartQTL(
#   dfResults = dfResults %>% filter(GroupLevel == "Site", SnapshotDate == latest_snapshot, GroupID != "Upper_funnel"),
#   dfGroups = dfGroups,
#   strOutcome = "Metric"
# )
```



### Site
```{r, echo = FALSE, results = 'asis', fig.height=4}
sites_with_ineligible <- dfListing %>%  
  filter(Source != "Neither") %>% 
  pull(invid) %>% 
  unique()



site_bar <- dfListing %>% 
  mutate(fillcol = ifelse(Source == "Neither", "No Eligiblity Risk", "Ineligible")) %>%
  filter(invid %in% sites_with_ineligible) %>% 
  ggplot(., aes(y = forcats::fct_rev(forcats::fct_infreq(invid)), fill = fillcol)) +
  geom_bar() +
  labs(y = "Site", x = "Participant Count", fill = "Eligibility", title = "Count by site", caption = "Footnote: Excludes sites with no ineligible partipants.") +
  scale_fill_manual(values = c("Ineligible" = "#FF5859",
                               "Eligible" = "#00BFC4",
                               "Neither" = "#7CAE00")) +
  theme_classic() 
plotly::ggplotly(site_bar)
```



### Country
```{r, echo = FALSE, results = 'asis', fig.height=4}
countries_with_ineligible <- dfListing %>%  
  filter(Source != "Neither") %>% 
  pull(country) %>% 
  unique()
country_bar <- dfListing %>% 
  mutate(fillcol = ifelse(Source == "Neither", "No Eligiblity Risk", "Ineligible")) %>%
  filter(country %in% countries_with_ineligible) %>% 
  ggplot(., aes(y = forcats::fct_rev(forcats::fct_infreq(country)), fill = fillcol)) +
  geom_bar() +
  labs(y = "Country", x = "Participant Count", fill = "Eligibility", title = "Count by country", caption = "Footnote: Excludes countries with no ineligible partipants.") +
  scale_fill_manual(values = c("Ineligible" = "#FF5859",
                               "Eligible" = "#00BFC4",
                               "Neither" = "#7CAE00")) +
  theme_classic() 
plotly::ggplotly(country_bar)
```



### Source
```{r, echo = FALSE, results = 'asis', fig.height=4}
source_bar <- dfListing %>% 
  filter(Source != "Neither") %>% 
  ggplot(., aes(x = Source, fill = Source)) +
  geom_bar()+
  labs(x = "Source", y = "Participant Count", title = "Count of Particpants by Category/Source") +
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),  # tilt to avoid overlap
    panel.grid.major.x = element_blank()
  ) 
plotly::ggplotly(source_bar)
```



### Criteria/Site
```{r, echo = FALSE, results = 'asis', fig.height=4}
site_criteria_bar <- dfListing %>% 
  filter(!is.na(ietestcd_concat) | Source == "Eligibility IPD") %>% 
  mutate(
    ietestcd_concat = case_when(
      is.na(ietestcd_concat) ~ "Eligibility IPD",
      stringr::str_detect(ietestcd_concat, ";;;") ~ "Multiple",
      TRUE ~ ietestcd_concat
    )
  ) %>%  
  ggplot(., aes(x = ietestcd_concat, fill = invid)) +
  geom_bar() +
  labs(x = "Criteria", y = "Criteria Count", fill = "Site", title = "Eligibility by site", caption = "Footnote: Partipants can be ineligible for multiple criteria.") + 
  theme_classic(base_size = 11) + 
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),  # tilt to avoid overlap
    panel.grid.major.x = element_blank()
  ) 
plotly::ggplotly(site_criteria_bar)
```



### Criteria/Country
```{r, echo = FALSE, results = 'asis', fig.height=4}
country_criteria_bar <- dfListing %>% 
  filter(!is.na(ietestcd_concat) | Source == "Eligibility IPD") %>% 
  mutate(
    ietestcd_concat = case_when(
      is.na(ietestcd_concat) ~ "Eligibility IPD",
      stringr::str_detect(ietestcd_concat, ";;;") ~ "Multiple",
      TRUE ~ ietestcd_concat
    )
  ) %>% 
  ggplot(., aes(x = ietestcd_concat, fill = country)) +
  geom_bar() +
  labs(x = "Criteria", y = "Criteria Count", fill = "Country", title = "Eligibility by Country", caption = "Footnote: Partipants can be ineligible for multiple criteria.") + 
  theme_classic(base_size = 11) + 
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),  # tilt to avoid overlap
    panel.grid.major.x = element_blank()
  ) 
plotly::ggplotly(country_criteria_bar)
```



## Inclusion/Exclusion Listing
```{r, echo = FALSE, results='asis'}
scrollable_gt <- function(gt_tbl, height = "300px", min_table_width = "1200px") {
  div(
    style = sprintf("
      max-height: %s;
      overflow-y: auto;
      overflow-x: auto;
      border: 1px solid #ccc;
    ", height),
    div(
      style = sprintf("min-width: %s;", min_table_width),
      gt_tbl
    )
  )
}

dfListing %>% 
  filter(Source != "Neither") %>% 
  select(invid, country, subjid, Source, ietestcd_concat, dvdtm, eligibility_criteria) %>% 
  # tidyr::separate(
  #   ietestcd_concat, 
  #   into = paste0("", seq_len(max(sapply(strsplit(dfListing$ietestcd_concat, ";;;"), length)))),
  #   sep = ";;;",
  #   fill = "right"
  # ) %>%
  tidyr::separate(
    dvdtm, 
    into = paste0("PD Date", seq_len(max(sapply(strsplit(dfListing$dvdtm, ";;;"), length)))),
    sep = ";;;",
    fill = "right"
  ) %>% 
  mutate_at(vars(starts_with("PD Date")) , ~substr(.x, 1, 10)) %>% 
  tidyr::separate(
    eligibility_criteria, 
    into = paste0("PD Term", seq_len(max(sapply(strsplit(dfListing$eligibility_criteria, ";;;"), length)))),
    sep = ";;;",
    fill = "right"
  ) %>% 
  rename(
    Site = invid,
    Country = country,
    `Subject ID` = subjid,
    `Which I/E` = ietestcd_concat
  ) %>% 
  gt::gt() %>%
  text_transform(
    locations = cells_body(columns = c(`Which I/E`, starts_with("PD Term"))),
    fn = function(x) {
      vapply(x, function(txt) {
        if (is.na(txt) || !nzchar(txt)) return("")

        # Tooltip: escape to be safe
        tooltip <- htmlEscape(txt)

        # Visual truncation logic based on plain text
        plain <- gsub("<[^>]+>", "", txt)
        should_truncate <- nchar(plain) > 10

        display_html <- if (should_truncate) {
          # You could optionally also truncate the HTML, but that's tricky.
          txt  # just use full HTML; visual cutoff will be via CSS
        } else {
          txt
        }

        html(
          sprintf(
            '<div title="%s" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100px;">%s</div>',
            tooltip, display_html
          )
        )
      }, FUN.VALUE = html(""))
    }
  ) %>% 
  # opt_interactive(use_search = TRUE,
  #                 use_filters = TRUE,
  #                 page_size_default = 25) %>% 
  scrollable_gt(., height = "500px")
```
