---
output:
  html_document:
    self_continaed: true
    mathjax: null
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
params:
  dfResults: NA
  dfGroups: NA
  dfListing: NA
---



```{r setup, include=FALSE} 
library(dplyr)
library(gsm.kri)
library(gsm.qtl)
library(ggplot2)
library(plotly)
library(reactable)
library(htmltools)



knitr::opts_chunk$set(warning = FALSE, message = FALSE)



dfResults <- params$dfResults
dfGroups <- params$dfGroups
dfListing <- params$dfListing



length_snapshots = dfResults$SnapshotDate %>% n_distinct()
latest_snapshot = unique(dfResults$SnapshotDate)[length_snapshots]
```



---
title: "QTL Overview"
subtitle: "Study: `r unique(dfListing$studyid)`"
date: "Snapshot Date: `r latest_snapshot`"
---



## Study Overview
```{r, echo=FALSE, results='asis'}
dfResults %>%
  filter(GroupLevel == "Study",
         SnapshotDate == latest_snapshot,
         !(GroupID %in% c("Upper_funnel", "Flatline"))) %>%
  mutate_at(c("Metric", "upper_funnel", "Numerator", "Denominator", "Flag"), as.numeric) %>%
  mutate(Ineligible_Rate = paste0(as.character(round(Metric,3)*100),"%"),
         Deviation = ifelse(Metric > upper_funnel, "Yes", "No"),
         upper_funnel = paste0(as.character(round(upper_funnel,3)*100), "%")) %>%
  mutate_all(as.character) %>%
  select(GroupID, Numerator, Denominator, Ineligible_Rate, upper_funnel, Deviation) %>%
  tidyr::pivot_longer(., cols = c(GroupID, Numerator, Denominator, Ineligible_Rate, upper_funnel, Deviation), names_to = "Param", values_to = "Value") %>%
  mutate(Param = case_when(
    Param == "GroupID" ~ "StudyID",
    Param == "Numerator" ~ "Ineligible",
    Param == "Denominator" ~ "Total Enrolled",
    Param == "Ineligible_Rate" ~ "Current Ineligible Enrolled Rate",
    Param == "upper_funnel" ~ "Current Threshold",
    Param == "Deviation" ~ "Deviation?"
  )) %>% 
  reactable()
```



# Results



## Time Series Chart
```{r, echo=FALSE, results='asis', fig.height=4}
# gsm.qtl::Widget_TimeSeriesQTL(
#   dfResults = dfResults %>% filter(GroupLevel == "Study"),
#   dfGroups = dfGroups,
#   strOutcome = "Metric"
# )
# Create reference table for funnel bounds per date
df_plot <- dfResults %>%
  filter(GroupLevel == "Study") %>%
  select(GroupID, Numerator, Denominator, Metric, SnapshotDate) %>%
  mutate(SnapshotDate = as.Date(SnapshotDate)) %>%
  # Add group type
  mutate(group_type = case_when(
    GroupID == "Upper_funnel" ~ "QTL Threshold",
    GroupID == "Flatline" ~ "Nominal Threshold",
    TRUE ~ "Ineligibility Rate"
  ))



# Pivot thresholds to wide format
thresholds <- df_plot %>%
  filter(GroupID %in% c("Upper_funnel", "Flatline")) %>%
  select(SnapshotDate, GroupID, Metric) %>%
  tidyr::pivot_wider(names_from = GroupID, values_from = Metric)



# Join thresholds to full data
df_joined <- df_plot %>%
  left_join(thresholds, by = "SnapshotDate") %>%
  mutate(
    # Point color logic for main group only
    point_color = case_when(
      group_type != "Ineligibility Rate" ~ NA_character_,
      Metric > `Upper_funnel` ~ "red",
      Metric > Flatline ~ "yellow",
      TRUE ~ "green"
    ),
    tooltip_text = case_when(
      group_type != "Ineligibility Rate" ~ paste0(
        group_type, "
",
        "Date: ", SnapshotDate, "
",
        "Metric: ", round(Metric, 3)
      ),
      TRUE ~ paste0(
        "Study: ", GroupID, "
",
        "Date: ", SnapshotDate, "
",
        "Metric: ", round(Metric, 3), "
",
        "Numerator: ", Numerator, "
",
        "Denominator: ", Denominator
      )
    )
  )



# Build ggplot
p <- ggplot(
  df_joined,
  aes(x = SnapshotDate, y = Metric, group = GroupID, text = tooltip_text)
) +
  # Line with custom linetype
  geom_line(
    data = df_joined %>%
      filter(group_type %in% c("Ineligibility Rate", "QTL Threshold", "Nominal Threshold")),
    aes(color = group_type, linetype = group_type),
    size = 1,
    show.legend = FALSE
  ) +
  
  # Colored points for Ineligibility Rate (keep color, hide legend)
  geom_point(
    data = df_joined %>% filter(group_type == "Ineligibility Rate"),
    aes(color = point_color),
    size = 2,
    show.legend = FALSE
  ) +
  
  # Points for thresholds (hide legend)
  geom_point(
    data = df_joined %>% filter(group_type != "Ineligibility Rate"),
    aes(color = group_type),
    size = 2,
    show.legend = FALSE
  ) +
  
  # Combine all colors in scale but only show legend for line groups
  scale_color_manual(
    values = c(
      "QTL Threshold" = "red",
      "Nominal Threshold" = "yellow",
      "Ineligibility Rate" = "grey40",
      "red" = "red",
      "yellow" = "yellow",
      "green" = "green"
    ),
    breaks = c("Ineligibility Rate", "Nominal Threshold", "QTL Threshold"),
    name = NULL
  ) +
  scale_linetype_manual(
    values = c(
      "QTL Threshold" = "dashed",
      "Nominal Threshold" = "dashed",
      "Ineligibility Rate" = "solid"
    )
  ) +
  
  # scale_x_date(date_labels = "%Y-%m-%d", date_breaks = "1 month") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 30),
    legend.position = "none"
  ) +
  labs(
    y = "Ineligibility",
    x = "Snapshot Date"
  )





ggplotly(p, tooltip = "text")
```



## Bar Charts {.tabset .tabset-pills}



```{r, eval = FALSE , echo = FALSE, results = 'asis', fig.height=4}
### JS - Site
# gsm.qtl::Widget_BarChartQTL(
#   dfResults = dfResults %>% filter(GroupLevel == "Site", SnapshotDate == latest_snapshot, GroupID != "Upper_funnel"),
#   dfGroups = dfGroups,
#   strOutcome = "Metric"
# )
```



### Site
```{r, echo = FALSE, results = 'asis', fig.height=4}
sites_with_ineligible <- dfListing %>%  
  mutate(fillcol = ifelse(Source == "Neither", "Eligible", "Ineligible")) %>% 
  filter(fillcol == "Ineligible") %>% 
  pull(invid) %>% 
  unique()



site_bar <- dfListing %>% 
  mutate(fillcol = ifelse(Source == "Neither", "Eligible", "Ineligible")) %>%
  filter(invid %in% sites_with_ineligible) %>% 
  ggplot(., aes(y = forcats::fct_rev(forcats::fct_infreq(invid)), fill = fillcol)) +
  geom_bar() +
  labs(y = "Site", x = "Count", fill = "Eligibility", title = "Count by site") +
  theme_classic() 
plotly::ggplotly(site_bar)
```



### Country
```{r, echo = FALSE, results = 'asis', fig.height=4}
countries_with_ineligible <- dfListing %>%  
  mutate(fillcol = ifelse(Source == "Neither", "Eligible", "Ineligible")) %>% 
  filter(fillcol == "Ineligible") %>% 
  pull(country) %>% 
  unique()
country_bar <- dfListing %>% 
  mutate(fillcol = ifelse(Source == "Neither", "Eligible", "Ineligible")) %>%
  filter(country %in% countries_with_ineligible) %>% 
  ggplot(., aes(y = forcats::fct_rev(forcats::fct_infreq(country)), fill = fillcol)) +
  geom_bar() +
  labs(y = "Country", x = "Count", fill = "Eligibility", title = "Count by country") +
  theme_classic() 
plotly::ggplotly(country_bar)
```



### Source
```{r, echo = FALSE, results = 'asis', fig.height=4}
source_bar <- dfListing %>% 
  filter(Source != "Neither") %>% 
  ggplot(., aes(x = Source, fill = Source)) +
  geom_bar()+
  labs(x = "Source", y = "Count", title = "Count of observations by Category/Source") +
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),  # tilt to avoid overlap
    panel.grid.major.x = element_blank()
  ) 
plotly::ggplotly(source_bar)
```



### Site/Criteria
```{r, echo = FALSE, results = 'asis', fig.height=4}
site_criteria_bar <- dfListing %>% 
  filter(!is.na(ietestcd) | Source == "Ineligible -- PD only, check IE") %>% 
  mutate(ietestcd = ifelse(is.na(ietestcd), "Ineligible -- PD only, check IE", ietestcd)) %>%  
  ggplot(., aes(x = ietestcd, fill = invid)) +
  geom_bar() +
  labs(x = "Criteria", y = "Count", fill = "Site", title = "Eligibility by site") + 
  theme_classic(base_size = 11) + 
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),  # tilt to avoid overlap
    panel.grid.major.x = element_blank()
  ) 
plotly::ggplotly(site_criteria_bar)
```



### Country/Criteria
```{r, echo = FALSE, results = 'asis', fig.height=4}
country_criteria_bar <- dfListing %>% 
  filter(!is.na(ietestcd) | Source == "Ineligible -- PD only, check IE") %>% 
  mutate(ietestcd = ifelse(is.na(ietestcd), "Ineligible -- PD only, check IE", ietestcd)) %>%  
  ggplot(., aes(x = ietestcd, fill = country)) +
  geom_bar() +
  labs(x = "Criteria", y = "Count", fill = "Country", title = "Eligibility by Country") + 
  theme_classic(base_size = 11) + 
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),  # tilt to avoid overlap
    panel.grid.major.x = element_blank()
  ) 
plotly::ggplotly(country_criteria_bar)
```



## Inclusion/Exclusion Listing
```{r, echo = FALSE, results='asis'}
dfListing %>% 
  filter(Source != "Neither") %>% 
  select(invid, country, subjid, Source, ietestcd, dvdtm, eligibility_criteria) %>%
  rename(
    Site = invid,
    Country = country,
    `Subject ID` = subjid,
    `Which I/E` = ietestcd,
    `PD Date` = dvdtm,
    `PD Term` = eligibility_criteria
  ) %>% 
  reactable::reactable(
    .,
    searchable = TRUE
    # , 
    # columns = list(
    #   `PD Date` = colDef(
    #     cell = function(value) {
    #       tags$div(
    #         title = value,
    #         style = list(
    #           whiteSpace = "nowrap",
    #           overflow = "hidden",
    #           textOverflow = "ellipsis",
    #           maxWidth = "100px"
    #         ),
    #         value
    #       )
    #     }
    #   )
    # )
  )
```
