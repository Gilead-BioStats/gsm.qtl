---
output:
  html_document:
    mathjax: null
params:
  dfResults: NA
  dfGroups: NA
  dfListing: NA
---

```{r setup, include=FALSE} 
library(dplyr)
library(gsm.kri)
library(gsm.qtl)
library(ggplot2)
library(plotly)
library(gt)
library(htmltools)

knitr::opts_chunk$set(warning = FALSE, message = FALSE)

dfResults <- params$dfResults
dfGroups <- params$dfGroups
dfListing <- params$dfListing

length_snapshots = dfResults$SnapshotDate %>% n_distinct()
latest_snapshot = unique(dfResults$SnapshotDate)[length_snapshots]
```

---
title: "QTL Overview"
subtitle: "Study: `r unique(dfListing$studyid)`"
date: "Snapshot Date: `r latest_snapshot`"
---

## Study Overview
```{r, echo=FALSE, results='asis'}
QTL_Overview(dfResults = dfResults,
             strQTLid = "Analysis_qtl0001_study",
             dSnapshot = latest_snapshot,
             strNum = "Ineligible Participants",
             strDenom = "Total Enrolled", 
             strQTL = "Current Ineligible Enrolled Rate")
```

# Results

## Time Series Chart
```{r, echo=FALSE, results='asis', fig.height=4}
# gsm.qtl::Widget_TimeSeriesQTL(
#   dfResults = dfResults %>% filter(GroupLevel == "Study"),
#   dfGroups = dfGroups,
#   strOutcome = "Metric"
# )
# Create reference table for funnel bounds per date
QTL_lineplot(dfResults = dfResults, strQTLid = "Analysis_qtl0001_study",strQTL = "Ineligibility Rate")
```

## Bar Charts {.tabset .tabset-pills}

```{r, eval = FALSE , echo = FALSE, results = 'asis', fig.height=4}
### JS - Site
# gsm.qtl::Widget_BarChartQTL(
#   dfResults = dfResults %>% filter(GroupLevel == "Site", SnapshotDate == latest_snapshot, GroupID != "Upper_funnel"),
#   dfGroups = dfGroups,
#   strOutcome = "Metric"
# )
```

### Site
```{r, echo = FALSE, results = 'asis', fig.height=4}
eligibility_groupBar(df = dfListing, varGroupID = invid, strGroupLabel = "Site")
```

### Country
```{r, echo = FALSE, results = 'asis', fig.height=4}
eligibility_groupBar(df = dfListing, varGroupID = country, strGroupLabel = "Country")
```

### Source
```{r, echo = FALSE, results = 'asis', fig.height=4}
eligibility_sourceBar(df = dfListing)
```

### Criteria/Site
```{r, echo = FALSE, results = 'asis', fig.height=4}
criteria_groupBar(df = dfListing, varGroupID = invid, strGroupLabel = "Site")
```

### Criteria/Country
```{r, echo = FALSE, results = 'asis', fig.height=4}
criteria_groupBar(df = dfListing, varGroupID = country, strGroupLabel = "Country")
```

## Inclusion/Exclusion Listing
```{r, echo = FALSE, results='asis'}
eligibility_listing(df = dfListing)
```
