---
output:
  html_document:
    mathjax: null
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
    css: styles.css
params:
  dfResults: NA
  dfGroups: NA
  dfListing: NA
---

```{r setup, include=FALSE} 
library(dplyr)
library(gsm.kri)
library(gsm.qtl)
library(ggplot2)
library(reactable)

knitr::opts_chunk$set(warning = FALSE, message = FALSE) 

dfResultsStudy <- params$dfResults %>% filter(GroupLevel == "Study")
dfResultsSite <- params$dfResults %>% filter(GroupLevel == "Site")
dfGroups <- params$dfGroups
dfListing <- params$dfListing %>% 
  mutate(Source = case_when(
    enrollyn == "N" & is.na(eligibility_criteria) ~ "I/E Criteria Not Met",
    enrollyn == "N" & !is.na(eligibility_criteria) ~ "Both Criteria",
    enrollyn == "Y" & !is.na(eligibility_criteria) ~ "Eligibility IPD",
    enrollyn == "Y" & is.na(eligibility_criteria) ~ "Neither"
  ))

length_snapshots = dfResultsSite$SnapshotDate %>% n_distinct()
latest_snapshot = unique(dfResultsSite$SnapshotDate)[length_snapshots]
```

---
title: "QTL Overview"
subtitle: "Study: `r unique(dfListing$studyid)`"
date: "Snapshot Date: `r latest_snapshot`"
--- 

## Study Overview
```{r, echo=FALSE, results='asis'}
dfResultsStudy %>%
  filter(GroupLevel == "Study",
         SnapshotDate == latest_snapshot,
         GroupID != "Upper_funnel") %>%
  mutate(Ineligible_Rate = paste0(as.character(Metric*100),"%"),
         Deviation = ifelse(Metric > upper_funnel, "Yes", "No"),
         upper_funnel = paste0(as.character(round(upper_funnel,3)*100), "%")) %>%
  mutate_all(as.character) %>%
  select(GroupID, Numerator, Denominator, Ineligible_Rate, upper_funnel, Deviation) %>%
  tidyr::pivot_longer(., cols = c(GroupID, Numerator, Denominator, Ineligible_Rate, upper_funnel, Deviation), names_to = "Param", values_to = "Value") %>%
  mutate(Param = case_when(
    Param == "GroupID" ~ "StudyID",
    Param == "Numerator" ~ "Eligibility Not Met",
    Param == "Denominator" ~ "Total Enrolled",
    Param == "Ineligible_Rate" ~ "Current Ineligible Enrolled Rate",
    Param == "upper_funnel" ~ "Current Threshold",
    Param == "Deviation" ~ "Deviation?"
  )) %>% 
  reactable()
```

# Results

## Time Series Chart
```{r, echo=FALSE, results='asis', fig.height=4}
gsm.qtl::Widget_TimeSeriesQTL(
  dfResults = dfResultsStudy,
  dfGroups = dfGroups,
  strOutcome = "Metric"
)
```

## Summary Charts {.tabset .tabset-pills}

### JS - Site
```{r, echo = FALSE, results = 'asis', fig.height=4}
gsm.qtl::Widget_BarChartQTL(
  dfResults = dfResultsSite %>% filter(SnapshotDate == latest_snapshot, GroupID != "Upper_funnel"),
  dfGroups = dfGroups,
  strOutcome = "Metric"
)
```

### GG - Site
```{r, echo = FALSE, results = 'asis', fig.height=4}
dfListing %>% 
  mutate(fillcol = ifelse(Source == "Neither", "Eligible", "Ineligible")) %>% 
  ggplot(., aes(x = invid, fill = fillcol)) +
  geom_bar() +
  labs(x = "Site", y = "Count", fill = "Eligibility", title = "Count by site") +
  theme_classic()
```

### GG - Country
```{r, echo = FALSE, results = 'asis', fig.height=4}
dfListing %>% 
  mutate(fillcol = ifelse(Source == "Neither", "Eligible", "Ineligible")) %>% 
  ggplot(., aes(x = country, fill = fillcol)) +
  geom_bar() +
  labs(x = "Site", y = "Count", fill = "Eligibility", title = "Count by site") +
  theme_classic()
```

### GG - Source
```{r, echo = FALSE, results = 'asis', fig.height=4}
dfListing %>% 
  ggplot(., aes(x = Source, fill = Source)) +
  geom_bar()+
  labs(x = "Source", y = "Count", title = "Count of observations by Category/Source") +
  theme_classic()
```

### GG - Site/Criteria
```{r, echo = FALSE, results = 'asis', fig.height=4}
dfListing %>% 
  filter(!is.na(ietest) | Source == "Eligibility IPD") %>% 
  mutate(ietest = ifelse(is.na(ietest), "Eligibility IPD", ietest)) %>%  
  ggplot(., aes(x = ietest, fill = invid)) +
  geom_bar() +
  labs(x = "Criteria", y = "Count", fill = "Site", title = "Eligibility by site") + 
  theme_classic(base_size = 11) + 
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),  # tilt to avoid overlap
    panel.grid.major.x = element_blank()
  )
```

### GG - Country/Criteria
```{r, echo = FALSE, results = 'asis', fig.height=4}
dfListing %>% 
  filter(!is.na(ietest) | Source == "Eligibility IPD") %>% 
  mutate(ietest = ifelse(is.na(ietest), "Eligibility IPD", ietest)) %>%  
  ggplot(., aes(x = ietest, fill = country)) +
  geom_bar() +
  labs(x = "Criteria", y = "Count", fill = "Country", title = "Eligibility by Country") + 
  theme_classic(base_size = 11) + 
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),  # tilt to avoid overlap
    panel.grid.major.x = element_blank()
  )
```

## Inclusion/Exclusion Listing
```{r, echo = FALSE, results='asis'}
dfListing %>% 
  filter(!is.na(ietest) | !is.na(eligibility_criteria)) %>% 
  select(invid, country, subjid, Source, ietest, eligibility_criteria) %>%
  rename(
    Site = invid,
    Country = country,
    `Subject ID` = subjid,
    `Which I/E` = ietest,
    `PD Term` = eligibility_criteria
  ) %>% 
  reactable::reactable(., searchable = TRUE)
```

```{r echo=FALSE}
group_dropdown <- system.file('report', 'lib', 'overallGroupDropdown.js', package = "gsm.kri")
dropdown_drag <- system.file('report', 'lib', 'dragOverallGroupDropdown.js', package = "gsm.kri")
toggle_toc <- system.file('report', 'lib', 'toggleTOC.js', package = "gsm.kri")
```

```{js, file={group_dropdown}, echo=FALSE }
```

```{js, file={dropdown_drag}, echo=FALSE}
```

```{js, file={toggle_toc}, echo=FALSE}
```
