meta:
  Type: Mapped
  ID: EXCLUSION
  Description: Combining IE and PD data to create QTL participant level dataset
  Priority: 2
spec:
  Mapped_IE:
    studyid:
      type: character
    subjid:
      type: character
    tiver:
      type: character
    ietest:
      type: character
    ietestcd:
      type: character
    ieorres:
      type: character
    iecat_custom:
      type: character
    ie_violation:
      type: character
  Mapped_ENROLL:
    studyid:
      type: character
    subjid:
      type: character
    invid:
      type: character
    enrollyn:
      type: character
    country:
      type: character
  Mapped_PD:
    studyid:
      type: character
    subjid:
      type: character
    dvterm:
      type: character
    dvdecod:
      type: character
    deemedimportant:
      type: character
    dvdtm:
      type: timestamp
steps:
  - output: add_ie
    name: dplyr::left_join
    params:
      x: Mapped_ENROLL
      'y': Mapped_IE
      by:
        - subjid
        - studyid
  - output: pivot_pd
    name: gsm.core::RunQuery
    params:
      df: Mapped_PD
      strQuery: "SELECT studyid, subjid, dvdtm, array_to_string(array_agg(dvterm), ';') AS eligibility_criteria
                 FROM df
                 WHERE dvdecod IN ('Exclusion Criteria', 'Inclusion Criteria')
                 GROUP BY studyid, subjid, dvdtm"
  - output: premapped
    name: dplyr::left_join
    params:
      x: add_ie
      'y': pivot_pd
      by:
        - subjid
        - studyid
  - output: Mapped_EXCLUSION
    name: gsm.core::RunQuery
    params:
      df: premapped
      strQuery: "SELECT *,
        CASE
          WHEN ie_violation = 'Y' AND eligibility_criteria IS NULL THEN 'Ineligible -- IE only, check PD'
          WHEN ie_violation IS NULL AND eligibility_criteria IS NOT NULL THEN 'Ineligible -- PD only, check IE'
          WHEN ie_violation = 'Y' AND eligibility_criteria IS NOT NULL THEN 'Ineligible, Both Criteria'
        ELSE 'Neither'
      END AS Source  FROM df WHERE enrollyn = 'Y'"
