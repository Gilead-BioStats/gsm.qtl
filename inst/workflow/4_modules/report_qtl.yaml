meta:
  Type: Report
  ID: report_qtl
  Output: html
  Name: QTL Report
  Description: A report summarizing QTL
spec:
  Mapped_STUDCOMP:
    _all:
      required: true
  Mapped_SUBJ:
    studyid:
      type: character
    subjid:
      type: character
    country:
      type: character
  Mapped_EXCLUSION:
    _all:
      required: true
  Reporting_Results_Longitudinal:
    _all:
      required: true
  Reporting_Groups:
    _all:
      required: true
  Reporting_Metrics:
    _all:
      required: true
steps:
  # add listings
  - output: qtl0001
    name: gsm.core::RunQuery
    params:
      df: Mapped_EXCLUSION
      strQuery: "SELECT * FROM df"
  - output: qtl0002_preprocess
    name: dplyr::left_join
    params:
      'x': Mapped_STUDCOMP
      'y': Mapped_SUBJ
      'by':
        - 'studyid'
        - 'subjid'
  - output: disc_reasons_path
    name: system.file
    params:
      ...: "workflow/0_other/disc_reasons.yaml"
      package: "gsm.qtl"
  - output: qtl0002
    name: gsm.qtl::discontinuation_map_reasons
    params:
      df: qtl0002_preprocess
      yaml_path: disc_reasons_path
  - output: reporting_listings
    names: list
    params:
      'qtl0001': qtl0001
      'qtl0002': qtl0002
  - output: all_reportingResults
    name: gsm.core::RunQuery
    params:
      df: Reporting_Results_Longitudinal
      strQuery: |
        SELECT *
        FROM df
        WHERE GroupLevel = 'Study'
        ORDER BY MetricID
  - output: all_reportingGroups
    name: gsm.core::RunQuery
    params:
      df: Reporting_Groups
      strQuery: |
        SELECT *
        FROM df
        WHERE GroupLevel IN ('Site', 'Study')
  # Define the output directory for the report.
  - output: strSnapshotDate
    name: pull
    params:
      .data: Reporting_Results_Longitudinal
      var: SnapshotDate
  - output: strSnapshotDate
    name: max
    params:
      ...: strSnapshotDate
  - output: strOutputDir
    name: file.path
    params:
      outputs: outputs
      SnapshotDate: strSnapshotDate
  - output: strOutputDir
    name: normalizePath
    params:
      path: strOutputDir
  - output: strInputPath
    names: system.file
    params:
      ...: "report/Report_QTL.Rmd"
      package: "gsm.qtl"
  - output: lParams
    name: list
    params:
      'dfResults': all_reportingResults
      'dfMetrics': Reporting_Metrics
      'dfGroups': all_reportingGroups
      'lListings': reporting_listings
  - output: Report
    name: gsm.kri::RenderRmd
    params:
      lParams: lParams
      strOutputDir: strOutputDir
      strOutputFile: ID
      strInputPath: strInputPath
